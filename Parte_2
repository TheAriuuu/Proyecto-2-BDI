create table coordenadas_cantones_temp (provincia varchar(255), canton varchar(255), latitud float, longitud float);

COPY coordenadas_cantones_temp FROM 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\PostgreSQL 16\Documentation\coordenadas.txt' 
WITH (
    FORMAT text,
    DELIMITER ',',
    HEADER true
);


CREATE SCHEMA DATAMART;

create table DATAMART.GENDER (
  ID_Gender int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  Genero varchar(100) not null unique
);

create table DATAMART.DATE(
  Fecha date primary key not null unique,
  dia int not null,
  mes int not null,
  anio int not null
);

create table DATAMART.SITE(
  ID_Site int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  provincia varchar(100) not null,
  canton varchar(100) not null unique,
  latitud float,
  longitud float
);

create table DATAMART.CRIME(
  ID_Crime int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  delito varchar(255) not null unique
);

create table DATAMART.OIJ_INEC_FACT(
  ID int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	id_gender int not null,
	fecha date not null,
	id_site int not null,
	id_crime int not null,
   FOREIGN KEY (id_gender) REFERENCES DATAMART.GENDER(ID_Gender),
   FOREIGN KEY (fecha) REFERENCES DATAMART.DATE(fecha),
   FOREIGN KEY (id_site) REFERENCES  DATAMART.SITE(ID_Site),
   FOREIGN KEY (id_crime) REFERENCES DATAMART.CRIME(ID_Crime),
  crime_count int not null,
  average_employment_rate float not null,
UNIQUE (id_crime, fecha, id_gender, id_site)
);


--Procedimientos almacenados
CREATE OR REPLACE PROCEDURE InsertGenderToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
insert into  DATAMART.GENDER (genero)
	select tipo from oij_inec.genero
	on conflict do nothing;
END;
$$;

call InsertGenderToDatamart();


CREATE OR REPLACE PROCEDURE InsertDateToDatamart()
LANGUAGE plpgsql
AS $$
DECLARE
    fecha_val DATE;
BEGIN
    FOR fecha_val IN SELECT DISTINCT Fecha FROM OIJ_INEC.Delito_cometido LOOP
        BEGIN
            INSERT INTO DATAMART.DATE (Fecha, dia, mes, anio)
            VALUES (
                fecha_val,
                EXTRACT(DAY FROM fecha_val),
                EXTRACT(MONTH FROM fecha_val),
                EXTRACT(YEAR FROM fecha_val)
            )
            ON CONFLICT (Fecha) DO NOTHING; 
        END;
    END LOOP;
END;
$$;

call InsertDateToDatamart();

CREATE OR REPLACE PROCEDURE InsertSiteToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO DATAMART.Site (provincia, canton, latitud, longitud)
    SELECT p.nombre_provincia, c.nombre, co.latitud, co.longitud
    FROM  oij_inec.provincias p
    JOIN oij_inec.cantones c ON p.id_provincia = c.id_provincia
	left join coordenadas_cantones_temp co on p.nombre_provincia = co.provincia
	and c.nombre = co.canton
    ON CONFLICT (canton) DO NOTHING; 
END;
$$;

call InsertSiteToDatamart();

CREATE OR REPLACE PROCEDURE InsertCrimeToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
	INSERT INTO DATAMART.CRIME (delito)
	SELECT d.tipo_delito
	FROM oij_inec.delito d
	ON CONFLICT (delito) DO NOTHING;
END;
$$;

call InsertCrimeToDatamart();

CREATE OR REPLACE PROCEDURE InsertFactToDatamart()
LANGUAGE plpgsql
AS $$
DECLARE
    record RECORD;
BEGIN
    FOR record IN
        SELECT 
            c.ID_Crime,
            d.Fecha,
            g.ID_Gender,
            s.ID_Site,
            COUNT(*) AS crime_count,
            AVG(p.tasa_ocupacion) AS average_employment_rate
        FROM DATAMART.CRIME c
        JOIN OIJ_INEC.Delito_cometido dc ON dc.ID_Delito = c.ID_Crime
        JOIN DATAMART.DATE d ON d.Fecha = dc.Fecha
        JOIN DATAMART.GENDER g ON g.ID_Gender = dc.ID_Genero
        JOIN DATAMART.SITE s ON s.ID_Site = (SELECT ID_Site FROM DATAMART.SITE WHERE canton = (SELECT nombre FROM OIJ_INEC.Cantones WHERE ID_Canton = dc.ID_Canton LIMIT 1))
        JOIN OIJ_INEC.porcentajes p ON s.ID_Site = p.ID_canton
        GROUP BY c.ID_Crime, d.Fecha, g.ID_Gender, s.ID_Site
    LOOP
        INSERT INTO DATAMART.OIJ_INEC_FACT (id_crime, fecha, id_gender, id_site, crime_count, average_employment_rate)
        VALUES (
            record.ID_Crime, 
            record.Fecha, 
            record.ID_Gender,
            record.ID_Site,
            record.crime_count,
            record.average_employment_rate
        )
        ON CONFLICT (id_crime, fecha, id_gender, id_site) DO NOTHING;
    END LOOP;
END;
$$;


call InsertFactToDatamart();
