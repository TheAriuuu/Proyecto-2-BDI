create table coordenadas_cantones_temp (provincia varchar(255), canton varchar(255), latitud float, longitud float);

COPY coordenadas_cantones_temp FROM 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\PostgreSQL 16\Documentation\coordenadas.txt' 
WITH (
    FORMAT text,
    DELIMITER ',',
    HEADER true
);


CREATE SCHEMA DATAMART;

create table DATAMART.GENDER (
  ID_Gender int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  Genero varchar(100) not null unique
);

create table DATAMART.DATE(
  Fecha date primary key not null unique,
  dia int not null,
  mes int not null,
  anio int not null
);

create table DATAMART.SITE(
  ID_Site int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  provincia varchar(100) not null,
  canton varchar(100) not null,
  latitud float,
  longitud float
);

create table DATAMART.CRIME(
  ID_Crime int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  delito varchar(255) not null unique
);

create table DATAMART.OIJ_INEC_FACT(
  ID int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	id_gender int,
	fecha date,
	id_site int,
	id_crime int,
   FOREIGN KEY (id_gender) REFERENCES DATAMART.GENDER(ID_Gender),
   FOREIGN KEY (fecha) REFERENCES DATAMART.DATE(fecha),
   FOREIGN KEY (id_site) REFERENCES  DATAMART.SITE(ID_Site),
   FOREIGN KEY (id_crime) REFERENCES DATAMART.CRIME(ID_Crime),
  crime_count int,
  average_employment_rate float
);


--Procedimientos almacenados
CREATE OR REPLACE PROCEDURE InsertGenderToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
insert into  DATAMART.GENDER (genero)
	select tipo from oij_inec.genero
	on conflict do nothing;
END;
$$;

call InsertGenderToDatamart();


CREATE OR REPLACE PROCEDURE InsertDateToDatamart()
LANGUAGE plpgsql
AS $$
DECLARE
    fecha_val DATE;
BEGIN
    FOR fecha_val IN SELECT DISTINCT Fecha FROM OIJ_INEC.Delito_cometido LOOP
        BEGIN
            INSERT INTO DATAMART.DATE (Fecha, dia, mes, anio)
            VALUES (
                fecha_val,
                EXTRACT(DAY FROM fecha_val),
                EXTRACT(MONTH FROM fecha_val),
                EXTRACT(YEAR FROM fecha_val)
            ); 
        END;
    END LOOP;
END;
$$;

call InsertDateToDatamart();



CREATE OR REPLACE PROCEDURE InsertSiteToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO DATAMART.Site (provincia, canton, latitud, longitud)
    SELECT distinct p.nombre_provincia, c.nombre, co.latitud, co.longitud
    FROM  oij_inec.provincias p
    JOIN oij_inec.cantones c ON p.id_provincia = c.id_provincia
	left join coordenadas_cantones_temp co on p.nombre_provincia = co.provincia
	and c.nombre = co.canton; 
END;
$$;

call InsertSiteToDatamart();


CREATE OR REPLACE PROCEDURE InsertCrimeToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
	INSERT INTO DATAMART.CRIME (delito)
	SELECT distinct d.tipo_delito
	FROM oij_inec.delito d;
END;
$$;

call InsertCrimeToDatamart();



CREATE VIEW vista AS
SELECT 
    AVG(p.tasa_ocupacion) AS avg_tasa_ocupacion, 
    SUM(dc.id_delitocometido) AS total_delitos, 
    d.tipo_delito, 
    c.nombre AS canton, 
    dc.fecha, 
    h.tipo AS genero
FROM 
    oij_inec.porcentajes p
FULL OUTER JOIN 
    oij_inec.cantones c ON p.id_canton = c.id_canton
FULL OUTER JOIN 
    oij_inec.delito_cometido dc ON dc.id_canton = c.id_canton
JOIN 
    oij_inec.delito d ON d.id_delito = dc.id_delito
JOIN 
    oij_inec.genero h ON dc.id_genero = h.id_genero
GROUP BY 
    d.tipo_delito, c.nombre, dc.fecha, h.tipo;

CREATE OR REPLACE PROCEDURE InsertFactToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO datamart.oij_inec_fact (
        id_gender, fecha, id_site, id_crime, crime_count,  average_employment_rate
    )
    SELECT 
        g.id_gender,  v.fecha,  s.id_site,  c.id_crime, 
        COALESCE(SUM(v.total_delitos), 0) AS crime_count, 
        COALESCE(AVG(v.avg_tasa_ocupacion), 0) AS average_employment_rate 
    FROM vista v
    JOIN datamart.gender g ON g.genero = v.genero
    JOIN  datamart.date d ON d.fecha = v.fecha  
    JOIN datamart.site s ON s.canton = v.canton
    JOIN datamart.crime c ON c.delito = v.tipo_delito
    GROUP BY s.id_site, c.id_crime, g.id_gender, v.fecha;  
END;
$$;

call InsertFactToDatamart();
