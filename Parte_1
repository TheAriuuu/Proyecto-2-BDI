--1.1
CREATE TABLE  OIJ_TEMP (
    delito varchar(1000), 
    subdelito varchar(1000), 
    fecha varchar(1000), 
    hora varchar(1000),
    victima varchar(1000), 
    subvictima varchar(1000), 
    edad varchar(1000), 
    genero varchar(1000), 
    nacionalidad varchar(1000), 
    provincia varchar(1000), 
    canton varchar(1000), 
    distrito varchar(1000)
);

CREATE TABLE INEC_TEMP (
    provincia_canton VARCHAR(100),
    poblacion_15_mas INTEGER,
    tasa_participacion FLOAT,
    tasa_ocupacion FLOAT,
    tasa_desempleo FLOAT,
    porcentaje_inactiva FLOAT,
    relacion_dependencia FLOAT,
    sector_primario FLOAT,
    sector_secundario FLOAT,
    sector_terciario FLOAT
);

COPY oij_temp 
FROM 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\PostgreSQL 16\Documentation\oij.csv' 
DELIMITER ',' 
CSV HEADER;

ALTER TABLE oij_temp
DROP COLUMN distrito;

COPY inec_temp 
FROM 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\PostgreSQL 16\Documentation\inec.csv' 
DELIMITER ',' 
CSV HEADER;



--1.2
CREATE SCHEMA OIJ_INEC;

create table  OIJ_INEC.Provincias (
	ID_Provincia int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	nombre_provincia varchar(100) not null unique
);

create table  OIJ_INEC.cantones (
	ID_Canton int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	nombre varchar(100) not null unique,
	ID_Provincia int not null,
	constraint fk_provincia foreign key (ID_Provincia) references Provincias(ID_Provincia)
);

CREATE TABLE  OIJ_INEC.Subdelito (
    ID_SubDelito int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
    Tipo_subdelito VARCHAR(255) NOT NULL
);

CREATE TABLE  OIJ_INEC.Delito (
    ID_Delito int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
    Tipo_delito VARCHAR(255) NOT NULL,
    ID_SubDelito INT NOT NULL,
    FOREIGN KEY (ID_SubDelito) REFERENCES Subdelito(ID_SubDelito)
);

CREATE TABLE  OIJ_INEC.Edad (
    ID_edad int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
    Edad VARCHAR(255) NOT NULL
);

CREATE TABLE  OIJ_INEC.Subvictima (
    ID_subvictima int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
    Tipo_subvictima VARCHAR(255) NOT NULL
);

CREATE TABLE  OIJ_INEC.Victima (
    ID_victima int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
    Tipo_victima VARCHAR(255) NOT NULL,
    ID_Subvictima INT NOT NULL,
    FOREIGN KEY (ID_Subvictima) REFERENCES Subvictima(ID_subvictima)
);

create table  OIJ_INEC.genero (
	ID_Genero int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	tipo varchar(100) not null unique
);

create table  OIJ_INEC.nacionalidad (
	ID_nacionalidad int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	nombre varchar(100) not null unique
);

CREATE TABLE  OIJ_INEC.Delito_cometido (
	ID_DelitoCometido int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
 	ID_Delito INT NOT NULL,
    	Fecha DATE NOT NULL,
    	Hora TIMESTAMP NOT NULL,
    	ID_Victima INT NOT NULL,
    	ID_Edad INT NOT NULL,
	ID_Genero INT NOT NULL,
	ID_Nacionalidad INT NOT NULL,
    	ID_Canton INT NOT NULL,
    	FOREIGN KEY (ID_Delito) REFERENCES Delito(ID_Delito),
    	FOREIGN KEY (ID_Victima) REFERENCES Victima(ID_victima),
    	FOREIGN KEY (ID_Edad) REFERENCES Edad(ID_edad),
	FOREIGN KEY (ID_Genero) REFERENCES Genero(ID_Genero),
	FOREIGN KEY (ID_Nacionalidad) REFERENCES Nacionalidad(ID_nacionalidad),
    	FOREIGN KEY (ID_Canton) REFERENCES Cantones(ID_Canton)
);

create table  OIJ_INEC.porcentajes (
	ID int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	ID_canton int,
	mayores_De_14 float not null,
	tasa_participacion float not null,
	tasa_ocupacion float not null,
	tasa_desempleo float not null,
	economicamente_inactivos float not null,
	dependencia_economica float not null,
	sector_primario float not null,
	sector_secundario float not null,
	sector_terciario float not null,
	constraint fk_canton foreign key (ID_canton) references Cantones(ID_canton)
);

--Normalizaci√≥n
CREATE INDEX idx_id_provincia ON provincias(id_provincia);


CREATE INDEX indice_nombre_provincia ON provincias(nombre_provincia);


CREATE INDEX indice_nombre_provincia_temp ON oij_temp(provincia);

insert into provincias(nombre_provincia) 
SELECT DISTINCT lower(TRIM(provincia)) 
FROM oij_temp
ON CONFLICT (nombre_provincia) DO NOTHING; 


INSERT INTO cantones (nombre, id_provincia)
SELECT LOWER(TRIM(canton)), ID_Provincia
FROM oij_temp, provincias
where LOWER(TRIM(provincia)) = provincias.nombre_provincia
on conflict do nothing;

insert into nacionalidad (nombre) 
select nacionalidad from oij_temp
on conflict do nothing;

insert into genero (tipo)
	select genero from oij_temp
	on conflict do nothing;
