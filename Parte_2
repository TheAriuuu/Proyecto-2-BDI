CREATE SCHEMA DATAMART;

create table DATAMART.GENDER (
  ID_Gender int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  Genero varchar(100) not null unique
);

create table DATAMART.DATE(
  Fecha date primary key not null unique,
  dia int not null,
  mes int not null,
  anio int not null
);

create table DATAMART.SITE(
  ID_Site int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  provincia varchar(100) not null,
  canton varchar(100) not null unique
);

create table DATAMART.CRIME(
  ID_Crime int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
  delito varchar(255) not null unique
);

create table DATAMART.OIJ_INEC_FACT(
  ID int primary key GENERATED BY DEFAULT AS IDENTITY (start with 1) not null,
	id_gender int not null,
	fecha date not null,
	id_site int not null,
	id_crime int not null,
   FOREIGN KEY (id_gender) REFERENCES DATAMART.GENDER(ID_Gender),
   FOREIGN KEY (fecha) REFERENCES DATAMART.DATE(fecha),
   FOREIGN KEY (id_site) REFERENCES  DATAMART.SITE(ID_Site),
   FOREIGN KEY (id_crime) REFERENCES DATAMART.CRIME(ID_Crime),
  crime_count int not null,
  average_employment_rate float not null,
UNIQUE (id_crime, fecha, id_gender, id_site)
);


--Procedimientos almacenados

insert into  DATAMART.GENDER (genero)
	select tipo from oij_inec.genero
	on conflict do nothing;

CREATE OR REPLACE PROCEDURE InsertDateToDatamart()
LANGUAGE plpgsql
AS $$
DECLARE
    fecha_val DATE;
BEGIN
    FOR fecha_val IN SELECT DISTINCT Fecha FROM OIJ_INEC.Delito_cometido LOOP
        BEGIN
            INSERT INTO DATAMART.DATE (Fecha, dia, mes, anio)
            VALUES (
                fecha_val,
                EXTRACT(DAY FROM fecha_val),
                EXTRACT(MONTH FROM fecha_val),
                EXTRACT(YEAR FROM fecha_val)
            )
            ON CONFLICT (Fecha) DO NOTHING; 
        END;
    END LOOP;
END;
$$;

call InsertDateToDatamart();

CREATE OR REPLACE PROCEDURE InsertSiteToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO DATAMART.Site (provincia, canton)
    SELECT p.nombre_provincia, c.nombre
    FROM oij_inec.provincias p
    JOIN oij_inec.cantones c ON p.id_provincia = c.id_provincia
    ON CONFLICT (canton) DO NOTHING; 
END;
$$;

call InsertSiteToDatamart();

CREATE OR REPLACE PROCEDURE InsertCrimeToDatamart()
LANGUAGE plpgsql
AS $$
BEGIN
	INSERT INTO DATAMART.CRIME (delito)
	SELECT d.tipo_delito
	FROM oij_inec.delito d
	ON CONFLICT (delito) DO NOTHING;
END;
$$;

call InsertCrimeToDatamart();
